name: Deploy GitHub Pages

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'docs/**'
      - '*.md'
      - '.github/workflows/pages.yml'
      - 'scripts/copy-docs-to-jekyll.py'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for MD file changes
        id: check-changes
        run: |
          # Lista de arquivos .md mapeados que podem ter sido alterados (em inglês na raiz)
          MAPPED_FILES="USAGE.md ENV_SETUP.md CONTRIBUTING.md GITFLOW.md TESTING.md CHANGELOG.md AI_AGENT_EXAMPLE.md CREDENTIALS_CONSTRUCTOR_EXAMPLE.md"
          
          # Verifica se algum arquivo mapeado foi alterado neste commit
          CHANGED_FILES=""
          if [ "${{ github.event_name }}" = "push" ] && [ -n "${{ github.event.before }}" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -E '\.(md)$' || true)
          else
            # Se não temos histórico (workflow_dispatch ou primeiro commit), verifica todos os arquivos mapeados
            CHANGED_FILES=$(echo "$MAPPED_FILES")
          fi
          
          HAS_MAPPED_CHANGES=false
          for file in $MAPPED_FILES; do
            if echo "$CHANGED_FILES" | grep -q "^$file$"; then
              HAS_MAPPED_CHANGES=true
              echo "Arquivo mapeado alterado: $file"
            fi
          done
          
          # Também verifica se algum arquivo em docs/pt/ foi alterado diretamente
          if echo "$CHANGED_FILES" | grep -q "^docs/pt/"; then
            echo "Arquivos em docs/pt/ foram alterados diretamente"
          fi
          
          if [ "$HAS_MAPPED_CHANGES" = true ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Arquivos .md mapeados foram alterados, atualizando documentação..."
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "Nenhum arquivo .md mapeado foi alterado"
          fi

      - name: Update Jekyll docs from root MD files
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "Executando script para copiar conteúdo dos arquivos .md da raiz..."
          python scripts/copy-docs-to-jekyll.py
          
          # Verifica se houve mudanças
          if [ -n "$(git status --porcelain docs/pt/)" ]; then
            echo "Mudanças detectadas nos arquivos docs/pt/"
            git status
          else
            echo "Nenhuma mudança detectada"
          fi

      - name: Commit updated docs
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Verifica se há mudanças para commitar
          if [ -n "$(git status --porcelain docs/pt/)" ]; then
            git add docs/pt/
            git commit -m "docs: atualiza documentação em português a partir dos arquivos .md da raiz

            Arquivos atualizados automaticamente pelo workflow do GitHub Pages.
            [skip ci]"
            git push
            echo "Documentação atualizada e commitada com sucesso"
            
            # Aguarda um pouco para garantir que o push foi processado
            sleep 2
            
            # Faz checkout novamente para pegar as mudanças mais recentes
            git fetch
            git checkout ${{ github.ref }}
          else
            echo "Nenhuma mudança para commitar"
          fi

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          cache-version: 0

      - name: Setup Pages
        id: pages
        uses: actions/configure-pages@v4

      - name: Build with Jekyll
        run: |
          cd docs
          bundle install
          bundle exec jekyll build --baseurl "${{ steps.pages.outputs.base_path }}"
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/_site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

